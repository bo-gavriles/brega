let currentStep = 1;
const totalSteps = 3;
const form = document.getElementById('boatRequestForm');
const steps = document.querySelectorAll('.form-step');
const progressCircles = document.querySelectorAll('.step-circle');
const progressLabels = document.querySelectorAll('.step-label');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const finalMessage = document.getElementById('finalMessage');

const quickSubmitEndpoint = 'https://formspree.io/f/xpqaaeln';
const fullSubmitEndpoint = 'https://formspree.io/f/xpqajnbn';

const citiesByCountry = {
    russia: ["Sochi", "Gelendzhik", "Anapa", "Vladivostok", "Kaliningrad"],
    turkey: ["Bodrum", "Marmaris", "Fethiye", "Antalya", "Cesme"],
    uruguay: ["Punta del Este", "Montevideo", "La Paloma", "Piriápolis"],
    greece: ["Athens", "Mykonos", "Santorini", "Corfu", "Rhodes"],
    croatia: ["Split", "Dubrovnik", "Zadar", "Rovinj", "Hvar"],
    italy: ["Naples", "Rome", "Venice", "Sicily", "Sardinia"],
    spain: ["Barcelona", "Mallorca", "Ibiza", "Valencia", "Malaga"],
    france: ["Nice", "Cannes", "Saint-Tropez", "Marseille", "Corsica"],
    usa: ["Miami", "Fort Lauderdale", "San Diego", "Seattle", "Boston"]
};

const today = new Date().toISOString().split('T')[0];
document.getElementById('start_date').min = today;
document.getElementById('start_date').value = today;

const countrySelect = document.getElementById('country');
const citySelect = document.getElementById('city');

countrySelect.addEventListener('change', () => {
    const country = countrySelect.value;
    citySelect.innerHTML = '<option value="">Select city</option>';

    if (!country) {
        citySelect.disabled = true;
        citySelect.required = false;
        return;
    }

    if (citiesByCountry[country]) {
        citiesByCountry[country].forEach(city => {
            const option = document.createElement('option');
            option.value = city.toLowerCase().replace(/\s+/g, '_');
            option.textContent = city;
            citySelect.appendChild(option);
        });

        citySelect.disabled = false;
        citySelect.required = true;
    }
});

function updateProgress() {
    progressCircles.forEach((circle, index) => {
        if (index + 1 === currentStep) {
            circle.classList.add('active');
        } else if (index + 1 < currentStep) {
            circle.classList.add('active');
        } else {
            circle.classList.remove('active');
        }
    });

    progressLabels.forEach((label, index) => {
        if (index + 1 === currentStep || index + 1 < currentStep) {
            label.classList.add('active');
        } else {
            label.classList.remove('active');
        }
    });

    prevBtn.disabled = currentStep === 1;
    
    if (currentStep === totalSteps) {
        nextBtn.textContent = 'Submit';
        nextBtn.type = 'button'; // Importante: mantener como button
    } else {
        nextBtn.textContent = 'Next';
        nextBtn.type = 'button';
    }

    steps.forEach(step => {
        if (parseInt(step.dataset.step) === currentStep) {
            step.classList.add('active');
        } else {
            step.classList.remove('active');
        }
    });
}

function validateStep(step) {
    const currentStepElement = document.querySelector(`.form-step[data-step="${step}"]`);
    const requiredFields = currentStepElement.querySelectorAll('[required]');
    
    for (let field of requiredFields) {
        // Para checkboxes, verificar si están marcados
        if (field.type === 'checkbox') {
            if (!field.checked) {
                field.focus();
                return false;
            }
        } 
        // Para otros campos, verificar si tienen valor
        else if (!field.value.trim()) {
            field.focus();
            return false;
        }
        
        // Validación específica para email
        if (field.type === 'email') {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(field.value)) {
                field.focus();
                return false;
            }
        }
    }
    
    return true;
}

async function sendQuickContactInfo() {
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    
    const quickFormData = new FormData();
    quickFormData.append('name', name);
    quickFormData.append('email', email);
    quickFormData.append('phone', phone);
    quickFormData.append('source', 'boat_request_step1');
    
    try {
        await fetch(quickSubmitEndpoint, {
            method: 'POST',
            body: quickFormData,
            headers: {
                'Accept': 'application/json'
            }
        });
        console.log('Quick contact info submitted successfully');
    } catch (error) {
        console.error('Error sending quick contact info:', error);
    }
}

nextBtn.addEventListener('click', async function() {
    if (!validateStep(currentStep)) {
        showMessage('Please fill in all required fields correctly before proceeding.', 'error', finalMessage);
        return;
    }
    
    if (currentStep === 1) {
        await sendQuickContactInfo();
    }
    
    if (currentStep < totalSteps) {
        currentStep++;
        updateProgress();
        finalMessage.style.display = 'none'; // Ocultar mensajes al cambiar de paso
    } else {
        // En el último paso, ejecutar el envío del formulario
        submitBtn.click();
    }
});

prevBtn.addEventListener('click', function() {
    if (currentStep > 1) {
        currentStep--;
        updateProgress();
        finalMessage.style.display = 'none'; // Ocultar mensajes al cambiar de paso
    }
});

const budgetInput = document.getElementById('budget');
budgetInput.addEventListener('blur', () => {
    const value = parseInt(budgetInput.value);
    if (value && value < 100) {
        showMessage('For a better chance of acceptance, consider increasing your budget to at least $100.', 'error', finalMessage);
    }
});

form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const countrySelect = document.getElementById('country');
    const selectedCountry = countrySelect.value;
    
    let targetEndpoint;
    let isCaptainEndpoint = false;
    
    if (selectedCountry === 'turkey') {
        targetEndpoint = 'https://formspree.io/f/xdaozyzz';
        isCaptainEndpoint = true;
    } else if (selectedCountry === 'uruguay') {
        targetEndpoint = 'https://formspree.io/f/xkonbpqo';
        isCaptainEndpoint = true;
    } else {
        targetEndpoint = 'https://formspree.io/f/xpqajnbn';
        isCaptainEndpoint = false;
    }
    
    form.action = targetEndpoint;
    console.log(`Sending to ${selectedCountry} via ${targetEndpoint}, isCaptain: ${isCaptainEndpoint}`);
    
    const budgetValue = parseInt(budgetInput.value);
    if (budgetValue && budgetValue < 100) {
        if (!confirm('Your budget is below the recommended minimum of $100. This may reduce your chances of acceptance. Do you want to submit anyway?')) {
            nextBtn.disabled = false;
            nextBtn.textContent = 'Submit';
            prevBtn.disabled = false;
            return;
        }
    }
    
    nextBtn.disabled = true;
    prevBtn.disabled = true;
    nextBtn.textContent = 'Sending...';
    
    try {
        const formData = new FormData(form);
        
        const boatTypeSelect = document.getElementById('boat_type');
        const selectedOption = boatTypeSelect.options[boatTypeSelect.selectedIndex];
        formData.append('boat_type_display', selectedOption.text);
        
        if (isCaptainEndpoint) {
            console.log('Removing contact info for captains');
            formData.delete('email');
            formData.delete('phone');
            formData.append('recipient', 'captains');
        }
        
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (response.ok) {
            const message = isCaptainEndpoint 
                ? 'Thank you! Your request has been submitted successfully. Captains in ' + selectedCountry + ' will review your application.'
                : 'Thank you! Your request has been submitted successfully. Boat owners will contact you soon.';
            
            showMessage(message, 'success', finalMessage);
            
            setTimeout(() => {
                form.reset();
                currentStep = 1;
                updateProgress();
                finalMessage.style.display = 'none';
                nextBtn.disabled = false;
                nextBtn.textContent = 'Next';
                prevBtn.disabled = true;
                document.getElementById('start_date').value = today;
                citySelect.disabled = true;
                citySelect.innerHTML = '<option value="">Select city</option>';
                form.action = 'https://formspree.io/f/xpqajnbn';
            }, 5000);
        } else {
            showMessage('There was an error submitting your request. Please try again later.', 'error', finalMessage);
            nextBtn.disabled = false;
            nextBtn.textContent = 'Submit';
            prevBtn.disabled = false;
        }
    } catch (error) {
        console.error('Network error:', error);
        showMessage('Network error. Please check your connection and try again.', 'error', finalMessage);
        nextBtn.disabled = false;
        nextBtn.textContent = 'Submit';
        prevBtn.disabled = false;
    }
});

function showMessage(text, type, element) {
    element.textContent = text;
    element.className = `message ${type}`;
    element.style.display = 'block';
    
    if (type === 'success') {
        setTimeout(() => {
            element.style.display = 'none';
        }, 5000);
    }
}

updateProgress();

