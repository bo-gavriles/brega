let currentStep = 1;
const totalSteps = 6;
const form = document.getElementById('captainRegistrationForm');
const steps = document.querySelectorAll('.form-step');
const progressCircles = document.querySelectorAll('.step-circle');
const progressLabels = document.querySelectorAll('.step-label');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const finalMessage = document.getElementById('finalMessage');

// Character counters
document.getElementById('boat_name').addEventListener('input', function() {
    document.getElementById('name_counter').textContent = this.value.length;
});

document.getElementById('operating_areas').addEventListener('input', function() {
    document.getElementById('areas_counter').textContent = this.value.length;
});

document.getElementById('experience').addEventListener('input', function() {
    document.getElementById('exp_counter').textContent = this.value.length;
});

// Initialize counters
document.getElementById('name_counter').textContent = 
    document.getElementById('boat_name').value.length;

function updateProgress() {
    // Update step circles
    progressCircles.forEach((circle, index) => {
        if (index + 1 <= currentStep) {
            circle.classList.add('active');
        } else {
            circle.classList.remove('active');
        }
    });

    // Update step labels
    progressLabels.forEach((label, index) => {
        if (index + 1 <= currentStep) {
            label.classList.add('active');
        } else {
            label.classList.remove('active');
        }
    });

    // Update buttons
    prevBtn.disabled = currentStep === 1;
    
    if (currentStep === totalSteps) {
        nextBtn.textContent = 'Submit';
        nextBtn.type = 'button';
    } else {
        nextBtn.textContent = 'Next';
        nextBtn.type = 'button';
    }

    // Show current step
    steps.forEach(step => {
        if (parseInt(step.dataset.step) === currentStep) {
            step.classList.add('active');
        } else {
            step.classList.remove('active');
        }
    });
}

function validateStep(step) {
    const currentStepElement = document.querySelector(`.form-step[data-step="${step}"]`);
    const requiredFields = currentStepElement.querySelectorAll('[required]');
    
    for (let field of requiredFields) {
        // For checkboxes, check if they're checked
        if (field.type === 'checkbox') {
            if (!field.checked) {
                showStepMessage(`Please check the required checkbox: "${field.parentElement.textContent.trim()}"`, 'error');
                field.focus();
                return false;
            }
        } 
        // For radio buttons in step 3 (boat type)
        else if (field.name === 'boat_type' && step === 3) {
            const boatTypeSelected = currentStepElement.querySelector('input[name="boat_type"]:checked');
            if (!boatTypeSelected) {
                showStepMessage('Please select your boat type', 'error');
                return false;
            }
        }
        // For other fields, check if they have value
        else if (!field.value.trim()) {
            showStepMessage(`Please fill in the required field: "${field.previousElementSibling ? field.previousElementSibling.textContent.replace(' *', '') : 'This field'}"`, 'error');
            field.focus();
            return false;
        }
        
        // Email validation
        if (field.type === 'email' && field.value.trim()) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(field.value)) {
                showStepMessage('Please enter a valid email address', 'error');
                field.focus();
                return false;
            }
        }
        
        // Phone validation (basic)
        if (field.type === 'tel' && field.value.trim()) {
            const phoneRegex = /^[\d\s\-\+\(\)]{10,}$/;
            if (!phoneRegex.test(field.value.replace(/\s/g, ''))) {
                showStepMessage('Please enter a valid phone number', 'error');
                field.focus();
                return false;
            }
        }
    }
    
    return true;
}

function showStepMessage(text, type) {
    // Clear any existing messages
    const existingMessage = document.querySelector('.step-message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    // Create message element
    const message = document.createElement('div');
    message.className = `message ${type} step-message`;
    message.textContent = text;
    message.style.marginTop = '10px';
    message.style.marginBottom = '10px';
    
    // Insert message after the step description
    const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
    const stepDescription = currentStepElement.querySelector('.step-description');
    if (stepDescription) {
        stepDescription.parentNode.insertBefore(message, stepDescription.nextSibling);
    } else {
        const stepTitle = currentStepElement.querySelector('.step-title');
        stepTitle.parentNode.insertBefore(message, stepTitle.nextSibling);
    }
    
    // Auto-remove message after 5 seconds
    setTimeout(() => {
        if (message.parentNode) {
            message.remove();
        }
    }, 5000);
}

nextBtn.addEventListener('click', function() {
    if (!validateStep(currentStep)) {
        return;
    }
    
    if (currentStep < totalSteps) {
        currentStep++;
        updateProgress();
        // Clear any step messages when moving to next step
        const existingMessage = document.querySelector('.step-message');
        if (existingMessage) {
            existingMessage.remove();
        }
    } else {
        // Submit form
        submitBtn.click();
    }
});

prevBtn.addEventListener('click', function() {
    if (currentStep > 1) {
        currentStep--;
        updateProgress();
        // Clear any step messages when going back
        const existingMessage = document.querySelector('.step-message');
        if (existingMessage) {
            existingMessage.remove();
        }
    }
});

// Form submission
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Final validation before submission
    if (!validateStep(currentStep)) {
        return;
    }
    
    // Disable buttons
    nextBtn.disabled = true;
    prevBtn.disabled = true;
    nextBtn.textContent = 'Submitting...';
    
    try {
        const formData = new FormData(form);
        
        // Get boat type display value
        const boatTypeSelected = document.querySelector('input[name="boat_type"]:checked');
        if (boatTypeSelected) {
            const boatTypeLabel = boatTypeSelected.nextElementSibling.querySelector('.boat-name').textContent;
            formData.append('boat_type_display', boatTypeLabel);
        }
        
        // Send to Formspree
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (response.ok) {
            // Success
            finalMessage.textContent = 'Thank you! Your registration has been submitted successfully. You will receive a confirmation email shortly.';
            finalMessage.className = 'message success';
            finalMessage.style.display = 'block';
            
            // Reset form after 5 seconds
            setTimeout(() => {
                form.reset();
                currentStep = 1;
                updateProgress();
                finalMessage.style.display = 'none';
                nextBtn.disabled = false;
                nextBtn.textContent = 'Next';
                prevBtn.disabled = true;
                
                // Reset counters
                document.getElementById('name_counter').textContent = '0';
                document.getElementById('areas_counter').textContent = '0';
                document.getElementById('exp_counter').textContent = '0';
            }, 5000);
        } else {
            // Error
            finalMessage.textContent = 'There was an error submitting your registration. Please try again later.';
            finalMessage.className = 'message error';
            finalMessage.style.display = 'block';
            nextBtn.disabled = false;
            nextBtn.textContent = currentStep === totalSteps ? 'Submit' : 'Next';
            prevBtn.disabled = currentStep === 1;
        }
    } catch (error) {
        // Network error
        finalMessage.textContent = 'Network error. Please check your connection and try again.';
        finalMessage.className = 'message error';
        finalMessage.style.display = 'block';
        nextBtn.disabled = false;
        nextBtn.textContent = currentStep === totalSteps ? 'Submit' : 'Next';
        prevBtn.disabled = currentStep === 1;
        console.error('Form submission error:', error);
    }
});

// Add Enter key support for moving between steps
form.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        if (currentStep < totalSteps) {
            nextBtn.click();
        }
    }
});

// Initialize
updateProgress();

// Initialize areas and experience counters
document.getElementById('areas_counter').textContent = 
    document.getElementById('operating_areas').value.length;
document.getElementById('exp_counter').textContent = 
    document.getElementById('experience').value.length;

